<html>
	<head>
		<title></title>

		<style>
			body {
				margin: 0;
			}

			div {
				width: 100%;
				text-align: center;
			}

			img {
				width: 100%;
				height: auto;

				opacity: 0;

				position: absolute;
				left: 0;
				top: 0;
			}

			img.shown {

				opacity: 1;

				-webkit-transition : opacity 2s ease-in-out;
				-moz-transition    : opacity 2s ease-in-out;
				-ms-transition     : opacity 2s ease-in-out;
				-o-transition      : opacity 2s ease-in-out;
				transition         : opacity 2s ease-in-out;
			}
		</style>

		<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
		<script src="bluebird.js"></script>

		<script>
			$(function() {
				var Carousel_cycle_interval = 10 * 60 * 1000
				// for testing:
				// var Carousel_cycle_interval = 5 * 1000
				var Image_refresh_interval = 12 * 60 * 60 * 1000
				var Image_refresh_failure_wait = 10 * 1000
				var Image_fade_time = 2 * 1000 // sync this value with the stylesheet

				var parser = new DOMParser()

				var images = []

				function add_image(image) {
					if (images.indexOf(image) < 0) {
						images.push(image)

						if (images.length === 1) {
							carousel()
						}
					}
				}

				function carousel() {
					console.log('Start carousel')

					var index = 0
					function cycle() {
						if (index >= images.length) {
							index = 0
						}

						console.log('Cycling to image #' + index, images[index])
						console.log('Total images:', images.length)

						show_image(images[index])
						index++
					}

					cycle()
					setInterval(cycle, Carousel_cycle_interval)
				}

				var container = document.querySelector('div')

				function show_image(image) {
					console.log('Show image', image)

					var current_image = container.querySelector('img')

					var new_image = document.createElement('img')

					new_image.onload = function () {

						container.appendChild(new_image)

						setTimeout(function() {
							new_image.classList.add('shown')
						}, 
						100)

						if (current_image) {
							setTimeout(function() {
								container.removeChild(current_image)
							},
							Image_fade_time + 1 * 1000)
						}
					}

					new_image.src = image
				}

				function refresh_images() {
					console.log('Refreshing image list')

					var resolver = Promise.pending()

					// DeviantArt.com is blocked by the Russian Firewall, so using a public anonymous proxy
					$.ajax({
						// url: "http://anonymouse.org/cgi-bin/anon-www.cgi/http://www.deviantart.com/",
						url: 'http://localhost:9000/',
						data: { url: 'http://www.deviantart.com/' },
	    				dataType: "html"
					})
					.success(function(data) {
						// var html = $.parseHTML(data) 
						
						var document = parser.parseFromString(data, "text/html")
						var elements = document.querySelectorAll('.tinythumb')

						var elements_array = []
						var i = 0
						while (i < elements.length) {
							elements_array.push(elements[i])
							i++
						}

						Promise.map(elements_array, function(element) {
							// var resolver = Promise.pending()

							var deviation_link = element.parentNode.getAttribute('href')

							if (!deviation_link) {
								return;
							}

							$.ajax({
								// url: "http://anonymouse.org/cgi-bin/anon-www.cgi/http://www.deviantart.com/",
								url: 'http://localhost:9000/',
								data: { url: deviation_link },
			    				dataType: "html"
							})
							.success(function(data) {
								var document = parser.parseFromString(data, "text/html")
								var image = document.querySelector('img.dev-content-full')
								// resolver.resolve(image.getAttribute('src'))

								add_image(image.src)
							})
							.error(function(error) {
								console.error(error)
								// resolver.reject(error)
							})

							return resolver.promise
						})

						return resolver.resolve()
					})
					.error(function(error) {
						console.error(error)
						resolver.reject(error)
					})

					return resolver.promise
				}

				Element.prototype.prependChild = function(child) { this.insertBefore(child, this.firstChild); };
				
				refresh_images().then(function() {
					setTimeout(refresh_images, Image_refresh_interval)
				})
				.catch(function() {
					setTimeout(refresh_images, Image_refresh_failure_wait)
				})
			})
		</script>
	</head>

	<body>
		<div>
			<!-- <img/> -->
		</div>
	</body>
</html>